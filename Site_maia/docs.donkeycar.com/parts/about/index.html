<!DOCTYPE html>
<html class="writer-html5" lang="en" >

<!-- Mirrored from docs.donkeycar.com/parts/about/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 22 Nov 2022 13:08:36 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <link rel="shortcut icon" href="../../img/favicon.ico" />
    <title>About - Donkey Car</title>
    <link rel="stylesheet" href="../../css/theme.css" />
    <link rel="stylesheet" href="../../css/theme_extra.css" />
        <link rel="stylesheet" href="../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css" />
        <link href="../../extra.css" rel="stylesheet" />
    
      <script>
        // Current page data
        var mkdocs_page_name = "About";
        var mkdocs_page_input_path = "parts/about.md";
        var mkdocs_page_url = null;
      </script>
    
    <script src="../../js/jquery-3.6.0.min.js" defer></script>
    <!--[if lt IE 9]>
      <script src="../../js/html5shiv.min.js"></script>
    <![endif]-->
      <script src="../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script> 
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
          <a href="../../index.html" class="icon icon-home"> Donkey Car
        </a>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
                <li class="toctree-l1"><a class="reference internal" href="../../index.html">Home</a>
                </li>
              </ul>
              <p class="caption"><span class="caption-text">User Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/build_hardware/index.html">Build a car.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/install_software/index.html">Install the software.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/create_application/index.html">Create Donkeycar App.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/calibrate/index.html">Calibrate steering and throttle.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/get_driving/index.html">Get driving.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/train_autopilot/index.html">Train an autopilot.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../utility/ui/index.html">Donkey UI.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/deep_learning/simulator/index.html">Donkey Simulator.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/deep_learning/virtual_race_league/index.html">Virtual Race League.</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../guide/deep_learning/mobile_app/index.html">Mobile app</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Parts</span></p>
              <ul class="current">
                  <li class="toctree-l1 current"><a class="reference internal current" href="index.html">About</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#templates">Templates</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#parts">Parts</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#threaded-parts">Threaded Parts</a>
    </li>
    </ul>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../actuators/index.html">Actuators</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../controllers/index.html">Controllers</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../odometry/index.html">Odometry/encoders</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../rc/index.html">RC</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../rc_hat/index.html">RC Hat</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../keras/index.html">Keras</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../stores/index.html">Stores</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../fastai/index.html">Fastai</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../imu/index.html">IMU</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../lidar/index.html">Lidar</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../oled/index.html">OLED</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../pins/index.html">Pins</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../voice_control/index.html">Voice Control</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../stop_sign_detection/index.html">Stop Sign Detection</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Utilities</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../utility/donkey/index.html">donkey</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../utility/ui/index.html">UI</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Developer Guide</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../dev_guide/contribute/index.html">Contribute</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../dev_guide/tests/index.html">Tests</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../dev_guide/model/index.html">Create your own model</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Cars</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../cars/supported_cars/index.html">Supported Cars</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../cars/roll_your_own/index.html">Roll Your Own</a>
                  </li>
              </ul>
              <p class="caption"><span class="caption-text">Support</span></p>
              <ul>
                  <li class="toctree-l1"><a class="reference internal" href="../../support/faq/index.html">FAQ</a>
                  </li>
                  <li class="toctree-l1"><a class="reference internal" href="../../support/legacy/index.html">Legacy</a>
                  </li>
              </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">
      <nav class="wy-nav-top" role="navigation" aria-label="Mobile navigation menu">
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Donkey Car</a>
        
      </nav>
      <div class="wy-nav-content">
        <div class="rst-content"><div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html" class="icon icon-home" alt="Docs"></a> &raquo;</li>
          <li>Parts &raquo;</li>
      <li>About</li>
    <li class="wy-breadcrumbs-aside">
          <a href="https://github.com/autorope/donkeydocs/edit/master/docs/parts/about.md" class="icon icon-github"> Edit on GitHub</a>
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
            <div class="section" itemprop="articleBody">
              
                <h1 id="donkeycar-software-architecture">Donkeycar Software Architecture</h1>
<p>Donkeycar is very simple; code is organized into parts that take inputs and return outputs.  These parts are added to a vehicle.  The vehicle loop, once started, runs the parts in order.  The parts effectively communicate by reading and mutating the vehicle memory.</p>
<p>A 'template' is a python file that contains code to construct a 'vehicle' and one or more 'parts'.  A part is a Python class that wraps a functional component of a vehicle.  The parts are added to the vehicle.  The parts can take values from the vehicle's memory as inputs and can write values to the vehicle's memory as outputs.  When the vehicle loop is started the parts are run in the order that they were added; getting their inputs from memory and outputing their results to memory.  This continues in a loop until the vehicle is stopped, then all the parts are shutdown and the template exits.</p>
<h2 id="templates">Templates</h2>
<p>When you create your car application using the <code>donkey createcar ...</code> command as described in the <a href="../../guide/create_application/index.html">Create Donkeycar App</a> section of the docs, what happens under the hood is that a few files are copied from the <code>donkeycar/templates</code> folder into your my car folder.  The two we need to talk about are manage.py and myconfig.py.</p>
<p>The files that are copied to the mycar folder are renamed versions of a pair of template files in the templates folder.  The files are chosen based on the template name you passed in the <code>--template</code> argument to the <code>createcar</code> command; if you pass nothing then the default is <code>--template = complete</code>.  So <code>donkey createcar --path=~/mycar</code> is the same as <code>donkey createcar --path=~/mycar --template=complete</code>.  In this case then the files that are renamed and copied to <code>~/mycar/manage.py</code> and <code>~/mycar/myconfig.py</code> are <code>donkeycar/templates/complete.py</code> and <code>donkeycar/templates/cfg_complete.py</code> respectively. If you create a path follow application by passing <code>--template=path_follow</code> to createcar, then the files that are copied are <code>donkeycar/templates/path_follow.py</code> and <code>donkeycar/templates/cfg_path_follow.py</code></p>
<p>Now technically another copy of the <code>donkeycar/template/cfg_xxxx.py</code> is copied to the mycar folder as <code>config.py</code>; this contains the default configuration and should not be edited.  The myconfig.py file is really a commented out version of config.py.  To change your app's configuration (like to choose the kind of camera or drivetrain) uncomment the section you care about in myconfig.py and edit it.</p>
<p>The manage.py file is where that action really is; this is the code that runs your car.  It is organized into a 'vehicle loop' that runs at the rate specified by the <code>DRIVE_LOOP_HZ</code> value in your myconfig.py file; that is how often the vehicle loop's 'parts' will get updated.  The donkeycar vehicle loop is a pipeline of what we call 'parts' that get and set state in a hashmap we call 'memory'. </p>
<p>The complete.py and path_follow.py templates are fairly complex because they are very configurable.  However they are not in anyway special.  You can create your own template to do what you want; or you don't have create or use a template at all; you can write your own <code>manage.py</code> directly.  Here is an example of a vehicle loop with a single part that will accept a number, multiply it by a random number and return the result.  As the vehicle loop runs, the value will continue to get randomized.</p>
<pre><code class="language-python">import random

# the randomizer part
class RandPercent:
    def run(self, x):
        value = x * random.random()
        print(f&quot;{x} -&gt; {value}&quot;)
        return value

# create the vehicle and it's internal memory
V = dk.Vehicle()

# initialize the value in the vehicle's memory and give it a name
V.mem['var'] = 4

# add the part to read and write to the same value.
V.add(RandPercent, inputs=['var'], outputs=['var'])

# start the vehicle loop running; quit after 5 loops
V.start(max_loops=5)
</code></pre>
<h2 id="parts">Parts</h2>
<p>A part is a Python class that wraps a functional component of a vehicle.</p>
<p>These include:</p>
<ul>
<li>Sensors - Cameras, Lidar, Odometers, GPS ...</li>
<li>Actuators - Motor Controllers</li>
<li>Pilots - Lane Detectors, Behavioral Cloning models, ...</li>
<li>Controllers - Web based or Bluetooth.</li>
<li>Stores - Tub, or a way to save data.</li>
</ul>
<p>Tawn Kramer has created a video (actual two parts) that walks through <a href="https://www.youtube.com/watch?v=YZ4ESrtfShs">how to make a part</a>. Also, there is a video of a presentationat the Arm AIoT conference that shows <a href="https://youtu.be/GOkYPXheWSY?t=1213">how the OLED part was created</a>.</p>
<p>Each part is constructed and then added to the vehicle loop with its named inputs and named outputs specified.  The vehicle's parts are (for the most part) executed in the order that they are added to the vehicle loop.  Each time the vehicle loop runs the part's inputs are read from vehicle memory and passed to the part's run() method, the run() method does it's work, the returns the output values.  Here is an example of adding a part; the <a href="https://github.com/autorope/donkeycar/blob/main/donkeycar/parts/launch.py">AiLaunch part</a> overides the throttle when then driving mode transitions from manual driving to autopilot; it is used to private a high throttle for a short time at the very start of a race.  </p>
<pre><code class="language-python">    aiLauncher = AiLaunch(cfg.AI_LAUNCH_DURATION, cfg.AI_LAUNCH_THROTTLE, cfg.AI_LAUNCH_KEEP_ENABLED)
    V.add(aiLauncher,
          inputs=['user/mode', 'pilot/throttle'],
          outputs=['pilot/throttle'])
</code></pre>
<p>To implement this 'launch' it needs to know the current driving mode and the current autopilot throttle value; those are its inputs.  If it is not launching then it just passes the throttle value through without modifying it, but when it is launching it outputs a throttle valud equal to cfg.AI_LAUNCH_THROTTLE. So the throttle is it's only output. The par'ts run() method must take in these two inputs in the correct order and return the one output.  You can see this in part's code;</p>
<pre><code class="language-python">import time

class AiLaunch():
    '''
    This part will apply a large thrust on initial activation. This is to help
    in racing to start fast and then the ai will take over quickly when it's
    up to speed.
    '''

    def __init__(self, launch_duration=1.0, launch_throttle=1.0, keep_enabled=False):
        self.active = False
        self.enabled = False
        self.timer_start = None
        self.timer_duration = launch_duration
        self.launch_throttle = launch_throttle
        self.prev_mode = None
        self.trigger_on_switch = keep_enabled

    def enable_ai_launch(self):
        self.enabled = True
        print('AiLauncher is enabled.')

    def run(self, mode, ai_throttle):
        new_throttle = ai_throttle

        if mode != self.prev_mode:
            self.prev_mode = mode
            if mode == &quot;local&quot; and self.trigger_on_switch:
                self.enabled = True

        if mode == &quot;local&quot; and self.enabled:
            if not self.active:
                self.active = True
                self.timer_start = time.time()
            else:
                duration = time.time() - self.timer_start
                if duration &gt; self.timer_duration:
                    self.active = False
                    self.enabled = False
        else:
            self.active = False

        if self.active:
            print('AiLauncher is active!!!')
            new_throttle = self.launch_throttle

        return new_throttle
</code></pre>
<p>It is common for configuration values to be passed as arguments to a part's constructor, as they are in this example.  Also, if the part grabs some hardware resource, such as a camera or a serial port, it should also have a <code>shutdown</code> function that releases those resources properly when donkey is stopped.</p>
<p>So as we said, the part's run() method is called each time the vehicle loop is run; the input values are read from vehicle memory and passed as arguments to the run() method, which does it's work and then returns values that are then written to vehicle memory as outputs.  Since parts are run in the order they are added (for the most part) then you can see that you need to add a part that provides an output ahead of any part that needs that value as an input. </p>
<h2 id="threaded-parts">Threaded Parts</h2>
<p>I say 'for the most part' because you can also specify that a part is to be run in it's own thread so it can at it's own rate.  A threaded part has a <code>run_threaded()</code> method rather than a <code>run()</code> method; the inputs are arguments and the return values are outputs just like the <code>run()</code> method.  Also similar to the run() method, the run_threaded() method is called once each time the vehicle loop runs.  Here is an example of adding a threaded part to the vehicle loop.  This part interfaces to a TF-Mini single bean lidar via a serial port; it reports a distance.  It takes no input arguments and outputs just the distance value.  Note that the argument <code>inputs=[]</code> is not really necessary; that is the default for inputs so it can be left off.</p>
<pre><code class="language-python">    if cfg.HAVE_TFMINI:
        from donkeycar.parts.tfmini import TFMini
        lidar = TFMini(port=cfg.TFMINI_SERIAL_PORT)
        V.add(lidar, inputs=[], outputs=['lidar/dist'], threaded=True)
</code></pre>
<p>So if the run_threaded() part is called each time through the vehicle loop, just like the run() method, and it's inputs and outputs are organized just the like a non-threaded part, then what is the difference between a threaded part and a non-threaded part.  Once difference you can see above is that when you add a threaded part you pass <code>threaded=True</code>.  The other difference with a threaded part is that it must have a no-argument update() method.  When the threaded part is launched a thread is created and the part's update() method is registered as the method that is executed on the thread; the update() should run a loop doing it's work until the part is told to shutdown().  Here is a listing of the <a href="https://github.com/autorope/donkeycar/blob/main/donkeycar/parts/tfmini.py">TFMini part</a> to show this; </p>
<pre><code class="language-python">class TFMini:
    &quot;&quot;&quot;
    Class for TFMini and TFMini-Plus distance sensors.
    See wiring and installation instructions at https://github.com/TFmini/TFmini-RaspberryPi

    Returns distance in centimeters. 
    &quot;&quot;&quot;

    def __init__(self, port=&quot;/dev/serial0&quot;, baudrate=115200, poll_delay=0.01, init_delay=0.1):
        self.ser = serial.Serial(port, baudrate)
        self.poll_delay = poll_delay

        self.dist = 0

        if not self.ser.is_open:
            self.ser.close() # in case it is still open, we do not want to open it twice
            self.ser.open()

        self.logger = logging.getLogger(__name__)

        self.logger.info(&quot;Init TFMini&quot;)
        time.sleep(init_delay)

    def update(self):
        while self.ser.is_open:
            self.poll()
            if self.poll_delay &gt; 0:
                time.sleep(self.poll_delay)

    def poll(self):
        try:
            count = self.ser.in_waiting
            if count &gt; 8:
                recv = self.ser.read(9)   
                self.ser.reset_input_buffer() 

                if recv[0] == 0x59 and recv[1] == 0x59:     
                    dist = recv[2] + recv[3] * 256
                    strength = recv[4] + recv[5] * 256

                    if strength &gt; 0:
                        self.dist = dist

                    self.ser.reset_input_buffer()

        except Exception as e:
            self.logger.error(e)


    def run_threaded(self):
        return self.dist

    def run(self):
        self.poll()
        return self.dist

    def shutdown(self):
        self.ser.close()
</code></pre>
<blockquote>
<p>NOTE: The TFMini part manages a serial port itself; it is recommend to use the <a href="https://github.com/autorope/donkeycar/blob/main/donkeycar/parts/serial_port.py">SerialPort part</a> to read line oriented data from a serial port instead of managing the port in your part. The SerialPort part can handle all the details of the serial port and outputing the resulting data; then your part only needs to take that data as input and use it.</p>
</blockquote>
<p>In the TFMini part the update() method runs a loop as long as the serial port remains open.  The serial port is opened in the constructor and closed when the shutdown() method is called.  In a threaded part, the update() method is almost like an infinite loop, running over and over as much as python will give it time to run.  This is the section of code that can run much faster than the vehicle loop runs.  </p>
<p>The reason to use a threaded part is if your part needs to go faster than the vehicle loop or needs to respond to a device in closer to real time.  The loop in the <code>update()</code> method will run as fast as the python interpreter can let it, which will usually be much faster than the vehicle loop.  It's important to understand that the <code>update()</code> method is called by the part's thread BUT the <code>run_threaded()</code> method is called by the main vehicle loop thread.  This means that these two methods may interupt each other in the middle of what they are doing.  You should use approprate multi-thread patterns, such as mutexes, to make sure that data updates and/or reads and other critical sections of code are safely isolated and atomic.</p>
              
            </div>
          </div><footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="Footer Navigation">
        <a href="../../guide/deep_learning/mobile_app/index.html" class="btn btn-neutral float-left" title="Mobile app"><span class="icon icon-circle-arrow-left"></span> Previous</a>
        <a href="../actuators/index.html" class="btn btn-neutral float-right" title="Actuators">Next <span class="icon icon-circle-arrow-right"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org/">Read the Docs</a>.
</footer>
          
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="Versions">
  <span class="rst-current-version" data-toggle="rst-current-version">
    
        <span>
          <a href="https://github.com/autorope/donkeydocs/" class="fa fa-github" style="color: #fcfcfc"> GitHub</a>
        </span>
    
    
      <span><a href="../../guide/deep_learning/mobile_app/index.html" style="color: #fcfcfc">&laquo; Previous</a></span>
    
    
      <span><a href="../actuators/index.html" style="color: #fcfcfc">Next &raquo;</a></span>
    
  </span>
</div>
    <script>var base_url = '../../index.html';</script>
    <script src="../../js/theme_extra.js" defer></script>
    <script src="../../js/theme.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>

<!-- Mirrored from docs.donkeycar.com/parts/about/ by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 22 Nov 2022 13:08:36 GMT -->
</html>
